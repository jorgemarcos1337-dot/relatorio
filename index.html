<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Dashboard Manta – One Page</title>

<!-- ====== ESTILO BÁSICO ====== -->
<style>
    :root{
        --c1:#003d5b;--c2:#ffa630;--c3:#f4f4f4;--c4:#f2545b;--c5:#0f4c5c;
    }
    *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif;}
    body{margin:0;background:var(--c3);}
    header{position:sticky;top:0;background:#fff;padding:1rem 2rem;
           box-shadow:0 2px 6px rgba(0,0,0,.1);z-index:999;}
    h1{margin:0;color:var(--c1);}
    .kpi-wrap{display:flex;flex-wrap:wrap;gap:1rem;margin-top:.8rem;}
    .kpi{flex:1 0 180px;background:var(--c1);color:#fff;padding:1rem;border-radius:6px;}
    .kpi span{display:block;font-size:.9rem;opacity:.8}
    .kpi strong{font-size:1.6rem;font-weight:700}
    .filters{display:flex;flex-wrap:wrap;gap:1rem;margin-top:1rem}
    select{padding:.4rem .6rem;border:1px solid #ccc;border-radius:4px;}

    section{padding:2rem;max-width:1300px;margin:auto;}
    .sec-title{font-weight:600;color:var(--c5);margin-bottom:1rem}
    .two-cols{display:flex;flex-wrap:wrap;gap:2rem}
    .col{flex:1 1 480px}
    canvas{background:#fff;padding:1rem;border-radius:6px;height:320px!important}
    table.dataTable{width:100%!important;border-collapse:collapse!important;}
    table.dataTable thead{background:var(--c1);color:#fff}
    .dt-buttons{margin-bottom:.5rem}

    @media(max-width:800px){
        .two-cols{flex-direction:column}
    }
</style>

<!-- ====== LIBS ====== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link  href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

</head>
<body>

<header>
    <h1>Dashboard Manta</h1>

    <!-- FILTROS GLOBAIS -->
    <div class="filters">
        <label>
            Período 
            <select id="periodFilter">
                <option value="all">Últimos 12 meses</option>
                <!-- pronto para outras opções -->
            </select>
        </label>
        <label>
            Unidade 
            <select id="unitFilter" multiple size="1">
                <option value="all" selected>Todas</option>
                <option>712N</option><option>610S</option><option>VP</option>
                <option>303SW</option><option>702S</option>
            </select>
        </label>
        <button id="exportBtn">Exportar CSV</button>
    </div>

    <!-- KPIS -->
    <div class="kpi-wrap" id="kpiArea">
        <!-- preenchido via JS -->
    </div>
</header>

<!-- ====== PANORAMA EVASÃO ====== -->
<section>
    <h2 class="sec-title">Panorama da Evasão</h2>
    <div class="two-cols">
        <div class="col">
            <canvas id="pieMotivo"></canvas>
        </div>
        <div class="col">
            <canvas id="barTopUnits"></canvas>
        </div>
    </div>
</section>

<!-- ====== ANÁLISE DETALHADA ====== -->
<section>
    <h2 class="sec-title">Análise Detalhada</h2>
    <div class="two-cols">
        <div class="col">
            <canvas id="barEvasaoIdade"></canvas><br>
            <canvas id="lineTipoIdade"></canvas><br>
            <table id="tabUnidades" class="display"></table>
        </div>
        <div class="col">
            <canvas id="barLtvIdade"></canvas><br>
            <canvas id="lineTempoIdade"></canvas><br>
            <table id="tabAtivos"  class="display"></table>
        </div>
    </div>
</section>

<!-- =================== JS PRINCIPAL =================== -->
<script>
/* ======= DADOS (extraídos do DOCX) ======= */
const raw = {
    kpis:{ativos:4441,evasao:2211,churn:'33,3%',impacto:'R$ 8.901.180,36'},
    motivo:{desistentes:1366,cancelados:845},
    unidades:[
        {unidade:'712N',evasao:704,desistentes:472,cancelados:232,percDes:67,impacto:278319.36},
        {unidade:'610S',evasao:584,desistentes:328,cancelados:256,percDes:56.2,impacto:194699.76},
        {unidade:'VP',   evasao:385,desistentes:210,cancelados:175,percDes:54.5,impacto:70766.85},
        {unidade:'303SW',evasao:282,desistentes:178,cancelados:104,percDes:63.1,impacto:101917.62},
        {unidade:'702S',evasao:256,desistentes:178,cancelados:78, percDes:69.5,impacto:96061.44}
    ],
    idadeEvasao:[
        {idade:0, total:69},{idade:1,total:268},{idade:2,total:373},{idade:3,total:402},
        {idade:4,total:454},{idade:5,total:444},{idade:6,total:397},/* … simplificado */ 
        {idade:12,total:52},{idade:13,total:43},{idade:14,total:31}
    ],
    idadeLtv:[ /* dados resumidos */ 
        {idade:0, ltv:735},{idade:4, ltv:7136},{idade:5,ltv:8245},{idade:12,ltv:11280},
        {idade:65,ltv:13556},{idade:89,ltv:34920}
    ],
    idadeTempo:[
        {idade:0, tempo:2.1},{idade:4,tempo:20.4},{idade:5,tempo:23.6},{idade:12,tempo:32.2},
        {idade:65,tempo:38.7},{idade:89,tempo:99.8}
    ],
    tipoPorIdade:[
        {idade:5,des:300,can:65},{idade:6,des:280,can:117} /* exemplo */
    ],
    ativosPorIdade:[
        {idade:4,ativos:454,tempo:20.4,ltv:7135.95},/* ... */
    ]
};

/* ========== ESTADO GLOBAL / FILTROS ========== */
let state = {period:'all',units:['all']};

/* ========== FUNÇÕES DE FILTRO ========== */
function applyFilters(dataKey){
    if(state.units.includes('all')) return raw[dataKey];
    return raw[dataKey].filter(d=> state.units.includes(d.unidade));
}

/* ========== RENDER KPIs ========== */
function renderKpis(){
    const area=document.getElementById('kpiArea');
    area.innerHTML='';
    const k = raw.kpis;
    const items=[
        {lbl:'Alunos Ativos',val:k.ativos},
        {lbl:'Total Evasão',val:k.evasao},
        {lbl:'Taxa de Churn',val:k.churn},
        {lbl:'Impacto Anual',val:k.impacto}
    ];
    items.forEach(i=>{
        area.insertAdjacentHTML('beforeend',
            `<div class="kpi"><span>${i.lbl}</span><strong>${i.val}</strong></div>`);
    });
}

/* ========== CHART HELPERS ========== */
const chartObjs={};         // armazena instâncias para atualização
function makeChart(id, type, cfg){            // cria ou atualiza
    if(chartObjs[id]){chartObjs[id].destroy();}
    chartObjs[id]=new Chart(document.getElementById(id),cfg);
}
/* ========== PANORAMA ========= */
function renderMotivo(){
    const d=raw.motivo;
    makeChart('pieMotivo','pie',{
        type:'doughnut',
        data:{labels:['Desistentes','Cancelados'],
              datasets:[{data:[d.desistentes,d.cancelados],
                         backgroundColor:[ 'var(--c4)','var(--c2)']}]},
        options:{plugins:{tooltip:{callbacks:{
                    label:(ctx)=>(ctx.label+': '+ctx.parsed+' ('+
                        (ctx.parsed*100/(d.desistentes+d.cancelados)).toFixed(1)+'%)')}}}}
    });
    // clique -> filtro
    document.getElementById('pieMotivo').onclick=e=>{
        const p=chartObjs.pieMotivo.getElementsAtEventForMode(e,'nearest',{intersect:true},true);
        if(!p.length) return;
        alert('Exemplo: aqui você poderia aplicar filtro por tipo ('+p[0].index+')');
    };
}

function renderTopUnits(){
    const data=applyFilters('unidades').slice().sort((a,b)=>b.evasao-a.evasao).slice(0,5);
    makeChart('barTopUnits','bar',{
        type:'bar',
        data:{
          labels:data.map(d=>d.unidade),
          datasets:[
            {label:'Desistentes',data:data.map(d=>d.desistentes),backgroundColor:'var(--c4)'},
            {label:'Cancelados', data:data.map(d=>d.cancelados), backgroundColor:'var(--c2)'}
          ]
        },
        options:{indexAxis:'y',responsive:true,scales:{x:{stacked:true},y:{stacked:true}}}
    });
    document.getElementById('barTopUnits').onclick=e=>{
        const p=chartObjs.barTopUnits.getElementsAtEventForMode(e,'nearest',{intersect:true},true);
        if(!p.length) return;
        const un=data[p[0].index].unidade;
        state.units=[un];
        document.querySelectorAll('#unitFilter option').forEach(o=>o.selected=(o.value===un));
        renderAll();
    };
}

/* ========= DETALHADO ========= */
function renderDetalhado(){
    /* Barras evasão idade */
    makeChart('barEvasaoIdade','bar',{
        type:'bar',
        data:{
            labels:raw.idadeEvasao.map(d=>d.idade),
            datasets:[{label:'Alunos Perdidos',data:raw.idadeEvasao.map(d=>d.total),
                       backgroundColor:'var(--c4)'}]
        },
        options:{responsive:true}
    });

    /* Linhas tipo por idade (dados exemplo) */
    makeChart('lineTipoIdade','line',{
        type:'line',
        data:{
            labels:raw.tipoPorIdade.map(d=>d.idade),
            datasets:[
                {label:'Desistentes',data:raw.tipoPorIdade.map(d=>d.des),
                 borderColor:'var(--c4)',fill:false},
                {label:'Cancelados',data:raw.tipoPorIdade.map(d=>d.can),
                 borderColor:'var(--c2)',fill:false}
            ]
        }
    });

    /* LTV por idade */
    makeChart('barLtvIdade','bar',{
        type:'bar',
        data:{
            labels:raw.idadeLtv.map(d=>d.idade),
            datasets:[{label:'LTV médio (R$)',data:raw.idadeLtv.map(d=>d.ltv),
                       backgroundColor:'var(--c1)'}]
        }
    });

    /* Tempo por idade */
    makeChart('lineTempoIdade','line',{
        type:'line',
        data:{
            labels:raw.idadeTempo.map(d=>d.idade),
            datasets:[{label:'Tempo médio (meses)',data:raw.idadeTempo.map(d=>d.tempo),
                       borderColor:'var(--c1)',fill:false}]
        }
    });
}

/* ========= TABELAS ========= */
let dtUnits,dtAtivos;
function renderTables(){
    // Unidades
    if(dtUnits)dtUnits.destroy();
    dtUnits = $('#tabUnidades').DataTable({
        data:raw.unidades,
        columns:[
            {title:'Unidade',data:'unidade'},
            {title:'Total Evasão',data:'evasao'},
            {title:'Desistentes',data:'desistentes'},
            {title:'Cancelados',data:'cancelados'},
            {title:'% Desistentes',data:'percDes',
             render:d=>d.toFixed(1)+' %'},
            {title:'Impacto Mensal (R$)',data:'impacto',
             render:d=>d.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
        ],
        paging:false,info:false
    });
    $('#tabUnidades tbody').on('click','tr',function(){
        const un=dtUnits.row(this).data().unidade;
        state.units=[un]; renderAll();
    });

    // Ativos por idade
    if(dtAtivos)dtAtivos.destroy();
    dtAtivos = $('#tabAtivos').DataTable({
        data:raw.ativosPorIdade,
        columns:[
            {title:'Idade',data:'idade'},
            {title:'Nº Ativos',data:'ativos'},
            {title:'Tempo Médio (meses)',data:'tempo'},
            {title:'LTV Médio (R$)',data:'ltv',
             render:d=>d.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
        ],
        paging:false,info:false
    });
}

/* ========= EXPORTAÇÃO ========= */
function exportCSV() {
    let csv='Unidade,Evasao,Desistentes,Cancelados,Impacto\n';
    applyFilters('unidades').forEach(r=>{
        csv+=`${r.unidade},${r.evasao},${r.desistentes},${r.cancelados},${r.impacto}\n`;
    });
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='dashboard-manta.csv';
    a.click();
}

/* ========= EVENTOS UI ========= */
document.getElementById('unitFilter').addEventListener('change',e=>{
    const opts=[...e.target.options].filter(o=>o.selected).map(o=>o.value);
    state.units=opts.length?opts:['all']; renderAll();
});
document.getElementById('periodFilter').addEventListener('change',e=>{
    state.period=e.target.value; renderAll();
});
document.getElementById('exportBtn').addEventListener('click',exportCSV);

/* ========= RENDER GERAL ========= */
function renderAll(){
    renderKpis();
    renderMotivo();
    renderTopUnits();
    renderDetalhado();
    renderTables();
}
renderAll();
</script>

</body>
</html>
